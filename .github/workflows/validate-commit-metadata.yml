name: 提交元資料驗證
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-commit-metadata:
    runs-on: ubuntu-latest
    steps:
      - name: 取出 PR 的所有提交
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: 檢查提交作者與提交者信箱
        run: |
          # 允許的網域列表
          ALLOWED_DOMAINS=("@machops\.io$" "@users\.noreply\.github\.com$")
          EXIT_CODE=0

          # 取得此 PR 的所有提交 SHA
          COMMITS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits" \
            | jq -r '.[].sha')

          for sha in $COMMITS; do
            AUTHOR_EMAIL=$(git show -s --format=%ae $sha)
            COMMITTER_EMAIL=$(git show -s --format=%ce $sha)
            AUTHOR_NAME=$(git show -s --format=%an $sha)
            COMMIT_MSG=$(git show -s --format=%s $sha)
            
            echo "正在檢查提交: $sha"
            echo "作者: $AUTHOR_NAME <$AUTHOR_EMAIL>"
            echo "訊息: $COMMIT_MSG"

            # 檢查作者信箱
            AUTHOR_VALID=0
            for domain in "${ALLOWED_DOMAINS[@]}"; do
              if [[ "$AUTHOR_EMAIL" =~ $domain ]]; then
                AUTHOR_VALID=1
                break
              fi
            done

            if [ $AUTHOR_VALID -eq 0 ]; then
              echo "❌ 錯誤: 作者信箱 $AUTHOR_EMAIL 不符合允許的網域。"
              EXIT_CODE=1
            fi

            # 檢查提交者信箱
            COMMITTER_VALID=0
            for domain in "${ALLOWED_DOMAINS[@]}"; do
              if [[ "$COMMITTER_EMAIL" =~ $domain ]]; then
                COMMITTER_VALID=1
                break
              fi
            done

            if [ $COMMITTER_VALID -eq 0 ]; then
              echo "❌ 錯誤: 提交者信箱 $COMMITTER_EMAIL 不符合允許的網域。"
              EXIT_CODE=1
            fi

            # 檢查提交訊息格式 (範例: 必須以 feat|fix|docs|style|refactor|test|chore 開頭)
            if [[ ! "$COMMIT_MSG" =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.*\))?:.+$ ]]; then
              echo "❌ 錯誤: 提交訊息格式不正確。請使用 Conventional Commits 格式 (例如: feat: add something)。"
              EXIT_CODE=1
            fi
          done

          exit $EXIT_CODE

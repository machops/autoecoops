name: Cloudflare Pages Simple Monitor

on:
  # å®šæœŸæª¢æŸ¥ï¼ˆæ¯å°æ™‚ï¼‰
  schedule:
    - cron: '0 * * * *'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      check_deployment:
        description: 'Check latest Cloudflare Pages deployment'
        required: false
        default: 'true'
  
  # PR æ™‚æª¢æŸ¥
  pull_request:
    paths:
      - 'frontend/project-01/**'
      - '.github/workflows/**'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-and-fix:
    name: Check Cloudflare Pages Status
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_PROJECT_NAME: autoecoops
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Check package.json configuration
        id: check_config
        run: |
          echo "=== Checking package.json build:cf configuration ==="
          
          # è®€å– build:cf å‘½ä»¤
          BUILD_CMD=$(node -p "require('./frontend/project-01/package.json').scripts['build:cf']")
          
          echo "Current build:cf command (first 200 chars):"
          echo "$BUILD_CMD" | head -c 200
          echo ""
          
          # æª¢æŸ¥é—œéµçµ„ä»¶
          ISSUES=0
          FIXES=""
          
          # æª¢æŸ¥ 1: wrangler.toml ç”Ÿæˆ
          if ! echo "$BUILD_CMD" | grep -q "wrangler.toml"; then
            echo "âŒ Missing wrangler.toml generation"
            ISSUES=$((ISSUES + 1))
            FIXES="$FIXES- Add wrangler.toml generation\n"
          else
            echo "âœ… wrangler.toml generation present"
          fi
          
          # æª¢æŸ¥ 2: nodejs_compat æ¨™å¿—
          if ! echo "$BUILD_CMD" | grep -q "nodejs_compat"; then
            echo "âŒ Missing nodejs_compat flag"
            ISSUES=$((ISSUES + 1))
            FIXES="$FIXES- Add nodejs_compat flag\n"
          else
            echo "âœ… nodejs_compat flag present"
          fi
          
          # æ£€æŸ¥ 3: _worker.js é‡å‘½å
          if ! echo "$BUILD_CMD" | grep -q "_worker.js"; then
            echo "âŒ Missing _worker.js renaming"
            ISSUES=$((ISSUES + 1))
            FIXES="$FIXES- Add _worker.js renaming\n"
          else
            echo "âœ… _worker.js renaming present"
          fi
          
          # æ£€æŸ¥ 4: _routes.json ç”Ÿæˆ
          if ! echo "$BUILD_CMD" | grep -q "_routes.json"; then
            echo "âŒ Missing _routes.json generation"
            ISSUES=$((ISSUES + 1))
            FIXES="$FIXES- Add _routes.json generation\n"
          else
            echo "âœ… _routes.json generation present"
          fi
          
          # æ£€æŸ¥ 5: æ­£ç¢ºçš„ JSON è½‰ç¾©
          if echo "$BUILD_CMD" | grep -q "&quot;"; then
            echo "âŒ Found HTML entity encoding (&quot;)"
            ISSUES=$((ISSUES + 1))
            FIXES="$FIXES- Fix HTML entity encoding\n"
          else
            echo "âœ… Correct JSON escape sequences"
          fi
          
          echo ""
          echo "Total issues: $ISSUES"
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "fixes=$FIXES" >> $GITHUB_OUTPUT

      - name: Fix configuration
        id: fix
        if: steps.check_config.outputs.issues > 0
        run: |
          echo "=== Applying fixes ==="
          
          python3 scripts/fix-package-json.py

      - name: Create commit and PR
        if: steps.check_config.outputs.issues > 0
        run: |
          echo "=== Creating fix PR ==="
          
          git config user.name "Auto-Fix Bot"
          git config user.email "autofix@ninja.ai"
          
          BRANCH_NAME="auto-fix/cloudflare-config-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          git add frontend/project-01/package.json
          git commit -m "fix: Auto-fix Cloudflare Pages build configuration

Fixed issues:
${{ steps.check_config.outputs.fixes }}

This ensures:
- wrangler.toml is generated with nodejs_compat flag
- _worker.js is properly renamed
- _routes.json is created
- Correct JSON escape sequences are used

Generated by auto-fix workflow."

      - name: Push branch
        if: steps.check_config.outputs.issues > 0
        run: |
          git remote set-url origin https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin $BRANCH_NAME

      - name: Create Pull Request
        if: steps.check_config.outputs.issues > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "ğŸ¤– fix: Auto-fix Cloudflare Pages configuration"
          body: |
            ## ğŸ¤– è‡ªå‹•ä¿®å¾© PR
            
            æ­¤ PR ç”±è‡ªå‹•åŒ–å·¥ä½œæµå‰µå»ºï¼Œç”¨æ–¼ä¿®å¾© Cloudflare Pages é…ç½®å•é¡Œã€‚
            
            ### æª¢æ¸¬åˆ°çš„å•é¡Œï¼š
            ${{ steps.check_config.outputs.fixes }}
            
            ### ä¿®å¾©å…§å®¹ï¼š
            - âœ… æ·»åŠ  wrangler.toml ç”Ÿæˆï¼ˆå« nodejs_compat æ¨™å¿—ï¼‰
            - âœ… æ·»åŠ  _worker.js é‡å‘½åæ­¥é©Ÿ
            - âœ… æ·»åŠ  _routes.json ç”Ÿæˆæ­¥é©Ÿ
            - âœ… ä¿®æ­£ JSON è½‰ç¾©åºåˆ—
            
            ### âš ï¸ é‡è¦ï¼šæ›´æ–° Cloudflare Pages é…ç½®
            
            åˆä½µæ­¤ PR å¾Œï¼Œè«‹æ›´æ–° Cloudflare Pages é…ç½®ï¼š
            
            **Build command:**
            ```bash
            pnpm install --no-frozen-lockfile && pnpm --filter="./frontend/project-01..." run build:cf
            ```
            
            **Build output directory:**
            ```
            frontend/project-01/.open-next
            ```
            
            ### ä¸‹ä¸€æ­¥ï¼š
            1. âœ… å¯©æŸ¥ä¸¦åˆä½µæ­¤ PR
            2. âœ… æ›´æ–° Cloudflare Pages é…ç½®ï¼ˆè¦‹ä¸Šæ–¹ï¼‰
            3. âœ… è§¸ç™¼é‡æ–°éƒ¨ç½²
            
            ---
            
            *æ­¤ PR ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ*
          labels: |
            automated-fix
            cloudflare-pages
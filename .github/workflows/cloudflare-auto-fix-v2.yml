name: Cloudflare Pages Complete Auto-Fix Loop

on:
  # Ëß∏ÁôºÊ¢ù‰ª∂
  workflow_run:
    workflows: ["Cloudflare Workers and Pages"]
    types: [completed]
    branches: [main, 'copilot/*']
  
  schedule:
    # ÊØèÂ∞èÊôÇÊ™¢Êü•‰∏ÄÊ¨°
    - cron: '0 * * * *'
  
  workflow_dispatch:
    inputs:
      force_fix:
        description: 'Force fix even if no issues detected'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_PROJECT_NAME: autoecoops

jobs:
  monitor-and-fix:
    name: Monitor Deployment and Auto-Fix
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Fetch Cloudflare deployment logs
        id: fetch_logs
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "=== Fetching Cloudflare Pages deployment logs ==="
          
          # Áç≤ÂèñÊúÄËøëÁöÑÈÉ®ÁΩ≤ÂàóË°®
          DEPLOYMENTS=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${CLOUDFLARE_PROJECT_NAME}/deployments?per_page=5" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")
          
          echo "$DEPLOYMENTS" > deployments.json
          
          # Ê™¢Êü•ÊúÄÊñ∞ÈÉ®ÁΩ≤ÁãÄÊÖã
          LATEST_STATUS=$(echo "$DEPLOYMENTS" | jq -r '.result[0].latest_stage.status')
          LATEST_DEPLOYMENT_ID=$(echo "$DEPLOYMENTS" | jq -r '.result[0].id')
          
          echo "Latest deployment status: $LATEST_STATUS"
          echo "Latest deployment ID: $LATEST_DEPLOYMENT_ID"
          
          echo "status=$LATEST_STATUS" >> $GITHUB_OUTPUT
          echo "deployment_id=$LATEST_DEPLOYMENT_ID" >> $GITHUB_OUTPUT

      - name: Get deployment logs
        id: get_logs
        if: steps.fetch_logs.outputs.status == 'failure'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "=== Getting deployment failure logs ==="
          
          # Áç≤ÂèñÊó•Ë™å
          LOGS=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${CLOUDFLARE_PROJECT_NAME}/deployments/${{ steps.fetch_logs.outputs.deployment_id }}/history/logs" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")
          
          echo "$LOGS" > deployment_logs.txt
          
          # ÂàÜÊûêÈåØË™§È°ûÂûã
          ERROR_TYPE="unknown"
          
          if echo "$LOGS" | grep -q "quot: not found"; then
            ERROR_TYPE="html_entity_encoding"
          elif echo "$LOGS" | grep -q "Could not resolve"; then
            ERROR_TYPE="missing_nodejs_compat"
          elif echo "$LOGS" | grep -q "No wrangler.toml"; then
            ERROR_TYPE="missing_wrangler_toml"
          elif echo "$LOGS" | grep -q "pnpm"; then
            ERROR_TYPE="pnpm_workspace_issue"
          elif echo "$LOGS" | grep -q "worker.js"; then
            ERROR_TYPE="missing_worker_renaming"
          fi
          
          echo "Error type detected: $ERROR_TYPE"
          echo "error_type=$ERROR_TYPE" >> $GITHUB_OUTPUT

      - name: Analyze and fix configuration
        id: fix
        run: |
          echo "=== Analyzing configuration ==="
          
          # Ê™¢Êü• package.json
          BUILD_CMD=$(node -p "require('./frontend/project-01/package.json').scripts['build:cf']")
          
          ISSUES=0
          FIXES_APPLIED=""
          
          # Ê™¢Êü•‰∏¶‰øÆÂæ©ÂêÑÁ®ÆÂïèÈ°å
          if echo "$BUILD_CMD" | grep -q "&quot;"; then
            echo "‚ùå Found HTML entity encoding"
            ISSUES=$((ISSUES + 1))
            FIXES_APPLIED="$FIXES_APPLIED - Fixed HTML entity encoding\n"
          fi
          
          if ! echo "$BUILD_CMD" | grep -q "nodejs_compat"; then
            echo "‚ùå Missing nodejs_compat flag"
            ISSUES=$((ISSUES + 1))
            FIXES_APPLIED="$FIXES_APPLIED - Added nodejs_compat flag\n"
          fi
          
          if ! echo "$BUILD_CMD" | grep -q "wrangler.toml"; then
            echo "‚ùå Missing wrangler.toml generation"
            ISSUES=$((ISSUES + 1))
            FIXES_APPLIED="$FIXES_APPLIED - Added wrangler.toml generation\n"
          fi
          
          if ! echo "$BUILD_CMD" | grep -q "_worker.js"; then
            echo "‚ùå Missing _worker.js renaming"
            ISSUES=$((ISSUES + 1))
            FIXES_APPLIED="$FIXES_APPLIED - Added _worker.js renaming\n"
          fi
          
          if ! echo "$BUILD_CMD" | grep -q "_routes.json"; then
            echo "‚ùå Missing _routes.json generation"
            ISSUES=$((ISSUES + 1))
            FIXES_APPLIED="$FIXES_APPLIED - Added _routes.json generation\n"
          fi
          
          # Â¶ÇÊûúÂº∑Âà∂‰øÆÂæ©ÊàñÊúâÂïèÈ°å
          if [ "${{ github.event.inputs.force_fix }}" == "true" ] || [ $ISSUES -gt 0 ]; then
            echo "=== Applying fixes ==="
            
            # ‰ΩøÁî® Python ËÖ≥Êú¨‰øÆÂæ© package.json
            python3 scripts/fix-package-json.py
          fi
          
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "fixes_applied=$FIXES_APPLIED" >> $GITHUB_OUTPUT

      - name: Test build locally
        id: test
        if: steps.fix.outputs.issues > 0 || github.event.inputs.force_fix == 'true'
        run: |
          echo "=== Testing build locally ==="
          cd frontend/project-01
          
          # ÂòóË©¶ÊßãÂª∫
          timeout 300 pnpm run build:cf 2>&1 | tee ../build-test.log || true
          
          # Ê™¢Êü•ÈóúÈçµÊñá‰ª∂ÊòØÂê¶ÁîüÊàê
          if [ -f ".open-next/wrangler.toml" ]; then
            echo "‚úÖ wrangler.toml generated"
            cat .open-next/wrangler.toml
          else
            echo "‚ùå wrangler.toml not generated"
          fi
          
          if [ -f ".open-next/_worker.js" ]; then
            echo "‚úÖ _worker.js generated"
          else
            echo "‚ùå _worker.js not generated"
          fi
          
          if [ -f ".open-next/_routes.json" ]; then
            echo "‚úÖ _routes.json generated"
            cat .open-next/_routes.json
          else
            echo "‚ùå _routes.json not generated"
          fi

      - name: Commit and push fixes
        if: steps.fix.outputs.issues > 0 || github.event.inputs.force_fix == 'true'
        run: |
          echo "=== Committing and pushing fixes ==="
          
          git config user.name "Auto-Fix Bot"
          git config user.email "autofix@ninja.ai"
          
          # ÂâµÂª∫ÂàÜÊîØ
          BRANCH_NAME="auto-fix/cloudflare-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # Êèê‰∫§Êõ¥Êîπ
          git add frontend/project-01/package.json
          git commit -m "fix: Auto-fix Cloudflare Pages deployment

Issues fixed:
${{ steps.fix.outputs.fixes_applied }}

Generated by auto-fix workflow"

      - name: Push and create PR
        if: steps.fix.outputs.issues > 0 || github.event.inputs.force_fix == 'true'
        run: |
          git remote set-url origin https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin $BRANCH_NAME

      - name: Create Pull Request
        if: steps.fix.outputs.issues > 0 || github.event.inputs.force_fix == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "ü§ñ fix: Auto-fix Cloudflare Pages deployment (auto-fix #$GITHUB_RUN_NUMBER)"
          body: |
            ## ü§ñ Ëá™Âãï‰øÆÂæ© PR
            
            Ê≠§ PR Áî±Ëá™ÂãïÂåñÂ∑•‰ΩúÊµÅÂâµÂª∫ÔºåÁî®Êñº‰øÆÂæ© Cloudflare Pages ÈÉ®ÁΩ≤ÂïèÈ°å„ÄÇ
            
            ### Ê™¢Ê∏¨Âà∞ÁöÑÂïèÈ°åÔºö
            ${{ steps.fix.outputs.fixes_applied }}
            
            ### ‰øÆÂæ©ÂÖßÂÆπÔºö
            - ‚úÖ Ê≠£Á¢∫ÁöÑ JSON ËΩâÁæ©ÔºàÊõøÊèõ HTML ÂØ¶È´îÁ∑®Á¢ºÔºâ
            - ‚úÖ Ê∑ªÂä† wrangler.toml ÁîüÊàêÔºàÂê´ nodejs_compat Ê®ôÂøóÔºâ
            - ‚úÖ Ê∑ªÂä† _worker.js ÈáçÂëΩÂêçÊ≠•È©ü
            - ‚úÖ Ê∑ªÂä† _routes.json ÁîüÊàêÊ≠•È©ü
            - ‚úÖ Ê∑ªÂä†Ë≥áÊ∫êË§áË£ΩÊ≠•È©ü
            
            ### ÈáçË¶ÅÊèêÈÜíÔºö
            
            **‚ö†Ô∏è Ë´ãÊõ¥Êñ∞ Cloudflare Pages ÈÖçÁΩÆÔºö**
            
            ÁôªÈåÑ Cloudflare Dashboard ‚Üí Pages ‚Üí autoecoops ‚Üí Settings ‚Üí Build & deployments
            
            **Build command:**
            ```bash
            pnpm install --no-frozen-lockfile && pnpm --filter="./frontend/project-01..." run build:cf
            ```
            
            **Build output directory:**
            ```
            frontend/project-01/.open-next
            ```
            
            ### ‰∏ã‰∏ÄÊ≠•Ôºö
            1. ‚úÖ ÂØ©Êü•Ê≠§ PR ÁöÑÊõ¥Êîπ
            2. ‚úÖ Êõ¥Êñ∞ Cloudflare Pages ÈÖçÁΩÆÔºàÂ¶ÇÊûúÈÇÑÊú™Êõ¥Êñ∞Ôºâ
            3. ‚úÖ Âêà‰ΩµÊ≠§ PR
            4. ‚úÖ Cloudflare Pages Â∞áËá™ÂãïÈáçÊñ∞ÈÉ®ÁΩ≤
            
            ---
            
            *Ê≠§ PR Áî± GitHub Actions Ëá™ÂãïÁîüÊàê - [Êü•ÁúãÂ∑•‰ΩúÊµÅÈÅãË°å](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          labels: |
            automated-fix
            cloudflare-pages
            auto-generated

      - name: Trigger Cloudflare redeployment
        if: steps.fix.outputs.issues > 0 || github.event.inputs.force_fix == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "=== Triggering Cloudflare redeployment ==="
          
          # Áç≤ÂèñÊúÄÊñ∞ÈÉ®ÁΩ≤
          LATEST_DEPLOYMENT=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${CLOUDFLARE_PROJECT_NAME}/deployments?per_page=1" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")
          
          PRODUCTION_BRANCH=$(echo "$LATEST_DEPLOYMENT" | jq -r '.result[0].deployment_trigger.metadata.branch')
          
          # Ëß∏ÁôºÈáçÊñ∞ÈÉ®ÁΩ≤
          curl -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${CLOUDFLARE_PROJECT_NAME}/deployments" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              &quot;branch&quot;: &quot;${PRODUCTION_BRANCH}&quot;,
              &quot;commit_sha&quot;: &quot;$(git rev-parse HEAD)&quot;
            }"
          
          echo "‚úÖ Cloudflare Pages redeployment triggered"

      - name: Create issue if auto-fix fails
        if: failure() && steps.fix.outputs.issues > 0
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Auto-fix workflow failed',
              body: `The auto-fix workflow failed to resolve the Cloudflare Pages deployment issue.
              
              Workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              Please investigate manually.`,
              labels: ['auto-fix', 'failed', 'needs-attention']
            })
version: "3.9"

x-common-env: &common-env
  NODE_ENV: development
  LOG_LEVEL: debug
  AUTH_SERVICE_URL: http://auth-service:4001
  MEMORY_HUB_URL: http://memory-hub:4002
  EVENT_BUS_URL: http://event-bus:4003
  POLICY_AUDIT_URL: http://policy-audit:4004
  INFRA_MANAGER_URL: http://infra-manager:4005
  OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318

services:
  # ========================================================================
  # Infrastructure
  # ========================================================================
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: autoecops
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================================================
  # Core Services
  # ========================================================================
  auth-service:
    build:
      context: ../core/auth-service
      dockerfile: Dockerfile
    ports:
      - "4001:4001"
      - "9090:9090"
    environment:
      <<: *common-env
      PORT: 4001
      OIDC_ISSUER_URL: http://keycloak:8080/realms/autoecops
      JWT_SECRET: dev-jwt-secret-change-in-production
      REDIS_URL: redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy

  memory-hub:
    build:
      context: ../core/memory-hub
      dockerfile: Dockerfile
    ports:
      - "4002:4002"
      - "9091:9091"
    environment:
      <<: *common-env
      PORT: 4002
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/autoecops
      REDIS_URL: redis://redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  event-bus:
    build:
      context: ../core/event-bus
      dockerfile: Dockerfile
    ports:
      - "4003:4003"
      - "9092:9092"
    environment:
      <<: *common-env
      PORT: 4003
      REDIS_URL: redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy

  policy-audit:
    build:
      context: ../core/policy-audit
      dockerfile: Dockerfile
    ports:
      - "4004:4004"
      - "9093:9093"
    environment:
      <<: *common-env
      PORT: 4004
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/policy_audit
    depends_on:
      postgres:
        condition: service_healthy

  infra-manager:
    build:
      context: ../core/infra-manager
      dockerfile: Dockerfile
    ports:
      - "4005:4005"
      - "9094:9094"
    environment:
      <<: *common-env
      PORT: 4005
      ARGOCD_SERVER_URL: https://argocd-server:443

  # ========================================================================
  # Platform Services
  # ========================================================================
  platform-01:
    build:
      context: ../platforms/platform-01
      dockerfile: Dockerfile
    ports:
      - "5001:5001"
      - "9101:9101"
    environment:
      <<: *common-env
      PORT: 5001
      REDIS_URL: redis://redis:6379
    depends_on:
      - auth-service
      - memory-hub
      - event-bus
      - policy-audit

  platform-02:
    build:
      context: ../platforms/platform-02
      dockerfile: Dockerfile
    ports:
      - "5002:5002"
      - "9102:9102"
    environment:
      <<: *common-env
      PORT: 5002
    depends_on:
      - auth-service
      - memory-hub
      - event-bus
      - policy-audit
      - infra-manager

  platform-03:
    build:
      context: ../platforms/platform-03
      dockerfile: Dockerfile
    ports:
      - "5003:5003"
      - "9103:9103"
    environment:
      <<: *common-env
      PORT: 5003
    depends_on:
      - auth-service
      - memory-hub
      - event-bus
      - policy-audit
      - infra-manager

volumes:
  postgres_data:
  redis_data:

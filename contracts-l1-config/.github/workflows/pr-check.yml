name: Pull Request Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
      - staging

# ç’°å¢ƒè®Šæ•¸
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ä»£ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ­·å²,ä¾›åˆ†æå·¥å…·ä½¿ç”¨
      
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: ESLint Check
        run: pnpm run lint
        
      - name: Prettier Check
        run: pnpm run format:check
        
      - name: TypeScript Type Check
        run: pnpm run type-check

  # å–®å…ƒæ¸¬è©¦
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run unit tests
        run: pnpm run test:unit --coverage
        
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          fail_ci_if_error: false

  # æ•´åˆæ¸¬è©¦(éœ€è¦æ•¸æ“šåº«)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: contracts_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run database migrations
        run: pnpm run db:migrate
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/contracts_test
      
      - name: Run integration tests
        run: pnpm run test:integration
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/contracts_test
          REDIS_URL: redis://localhost:6379

  # å®‰å…¨æƒæ
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
      
      - name: GitGuardian scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  # CodeRabbit AI ä»£ç¢¼å¯©æŸ¥
  ai-code-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: CodeRabbit AI Review
        uses: coderabbitai/openai-pr-reviewer@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          review_simple_changes: false
          review_comment_lgtm: false
          path_filters: |
            !**/*.md
            !**/*.txt
            !**/dist/**
            !**/node_modules/**

  # å»ºæ§‹æ¸¬è©¦
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [web, api, worker]
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build ${{ matrix.app }}
        run: pnpm run build --filter=@contracts-l1/${{ matrix.app }}
      
      - name: Check bundle size
        run: pnpm run analyze:bundle --filter=@contracts-l1/${{ matrix.app }}
        continue-on-error: true

  # æ¶æ§‹ä¸€è‡´æ€§æª¢æŸ¥
  architecture-check:
    name: Architecture Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for circular dependencies
        run: npx madge --circular --extensions ts,tsx apps packages
        continue-on-error: true
      
      - name: Validate module boundaries
        run: npx nx-enforce-module-boundaries
        continue-on-error: true
      
      - name: Check import conventions
        run: |
          echo "æª¢æŸ¥è·¨ä¸Šä¸‹æ–‡å°å…¥æ˜¯å¦éµå¾ªè¦ç¯„..."
          # è‡ªå®šç¾©è…³æœ¬æª¢æŸ¥å°å…¥è¦å‰‡
        continue-on-error: true

  # çµæœåŒ¯ç¸½
  pr-check-summary:
    name: PR Check Summary
    needs: [code-quality, unit-tests, integration-tests, security-scan, build-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.code-quality.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ] || \
             [ "${{ needs.build-test.result }}" != "success" ]; then
            echo "âŒ Some required checks failed"
            exit 1
          else
            echo "âœ… All required checks passed"
          fi
      
      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const results = {
              'Code Quality': '${{ needs.code-quality.result }}',
              'Unit Tests': '${{ needs.unit-tests.result }}',
              'Integration Tests': '${{ needs.integration-tests.result }}',
              'Security Scan': '${{ needs.security-scan.result }}',
              'Build Test': '${{ needs.build-test.result }}'
            };
            
            let comment = '## ğŸ¤– PR Check Results\n\n';
            for (const [name, result] of Object.entries(results)) {
              const icon = result === 'success' ? 'âœ…' : 'âŒ';
              comment += `${icon} **${name}**: ${result}\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
